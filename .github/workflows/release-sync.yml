name: Release Notify

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get linux-amd64.tar.gz asset URL
        id: asset
        run: |
          URL=$(echo '${{ toJson(github.event.release.assets) }}' \
            | jq -r '.[] | select(.name=="linux-amd64.tar.gz") | .browser_download_url')

          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "Asset linux-amd64.tar.gz not found"
            exit 1
          fi

          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Publish to Pusher
        run: |
          BODY=$(jq -nc \
            --arg tag "${{ github.event.release.tag_name }}" \
            --arg url "${{ steps.asset.outputs.url }}" \
            '{tag:$tag,url:$url}')

          curl -X POST \
            "https://api-${{ secrets.PUSHER_CLUSTER }}.pusher.com/apps/${{ secrets.PUSHER_APP_ID }}/events" \
            -u "${{ secrets.PUSHER_KEY }}:${{ secrets.PUSHER_SECRET }}" \
            -H "Content-Type: application/json" \
            -d "$(jq -nc \
              --argjson data "$BODY" \
              '{name:"release",channel:"updates",data:($data|tostring)}')"
